<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">StockPltr调试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .debug-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        .test-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        .status-success {
            color: #28a745;
        }
        .status-error {
            color: #dc3545;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/stockpltr/">
                <i class="bi bi-graph-up"></i> StockPltr
            </a>
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/stockpltr/stocks">股票列表</a>
                <a class="nav-link" href="/stockpltr/search">搜索</a>
                <a class="nav-link active" href="/stockpltr/debug">调试</a>
            </div>
        </div>
    </nav>

    <!-- 调试标题 -->
    <section class="debug-section">
        <div class="container">
            <h1 class="text-center mb-4">
                <i class="bi bi-bug"></i> StockPltr调试工具
            </h1>
            <p class="text-center lead">诊断和测试StockPltr爬虫功能</p>
        </div>
    </section>

    <!-- 调试工具 -->
    <div class="container mt-4">
        <div class="row">
            <!-- 基础测试 -->
            <div class="col-md-6 mb-4">
                <div class="card test-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-gear"></i> 基础功能测试</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="testBasic()">
                                <i class="bi bi-check-circle"></i> 测试基本功能
                            </button>
                            <button class="btn btn-outline-info" onclick="testWebDriver()">
                                <i class="bi bi-browser-chrome"></i> 测试WebDriver
                            </button>
                            <button class="btn btn-outline-success" onclick="testWebsite()">
                                <i class="bi bi-globe"></i> 测试网站访问
                            </button>
                        </div>
                        <div id="basicTestResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- 爬虫测试 -->
            <div class="col-md-6 mb-4">
                <div class="card test-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot"></i> 爬虫功能测试</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="testSymbol" class="form-label">测试股票代码</label>
                            <input type="text" class="form-control" id="testSymbol" value="AAPL" placeholder="输入股票代码">
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-warning" onclick="testSearch()">
                                <i class="bi bi-search"></i> 测试搜索
                            </button>
                            <button class="btn btn-outline-secondary" onclick="testDetail()">
                                <i class="bi bi-info-circle"></i> 测试详情获取
                            </button>
                            <button class="btn btn-outline-primary" onclick="testComments()">
                                <i class="bi bi-chat-dots"></i> 测试评论获取
                            </button>
                        </div>
                        <div id="crawlerTestResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 日志输出 -->
        <div class="row">
            <div class="col-12">
                <div class="card test-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-terminal"></i> 测试日志</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">
                            <i class="bi bi-trash"></i> 清空日志
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="logOutput" class="log-output">
                            <div class="text-muted">等待测试执行...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- API状态 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card test-card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> API状态</h5>
                    </div>
                    <div class="card-body">
                        <div id="apiStatus" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 StockPltr数据监控系统</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 日志输出
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `mb-1 ${type === 'error' ? 'status-error' : type === 'success' ? 'status-success' : ''}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // 清空日志
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '<div class="text-muted">日志已清空...</div>';
        }

        // 测试基本功能
        async function testBasic() {
            log('开始测试基本功能...');
            try {
                const response = await fetch('/api/stockpltr/test/basic');
                const data = await response.json();
                if (data.status === 'success') {
                    log('✅ 基本功能测试通过', 'success');
                    document.getElementById('basicTestResult').innerHTML = 
                        '<div class="alert alert-success">基本功能正常</div>';
                } else {
                    log('❌ 基本功能测试失败: ' + data.message, 'error');
                    document.getElementById('basicTestResult').innerHTML = 
                        '<div class="alert alert-danger">基本功能异常</div>';
                }
            } catch (error) {
                log('❌ 基本功能测试异常: ' + error.message, 'error');
                document.getElementById('basicTestResult').innerHTML = 
                    '<div class="alert alert-danger">测试异常</div>';
            }
        }

        // 测试WebDriver
        async function testWebDriver() {
            log('开始测试WebDriver...');
            try {
                const response = await fetch('/api/stockpltr/debug/webdriver');
                const data = await response.json();
                if (data.status === 'success') {
                    log('✅ WebDriver测试通过', 'success');
                } else {
                    log('❌ WebDriver测试失败: ' + data.message, 'error');
                }
            } catch (error) {
                log('❌ WebDriver测试异常: ' + error.message, 'error');
            }
        }

        // 测试网站访问
        async function testWebsite() {
            log('开始测试网站访问...');
            try {
                const response = await fetch('/api/stockpltr/debug/website');
                const data = await response.json();
                if (data.status === 'success') {
                    log('✅ 网站访问测试通过', 'success');
                } else {
                    log('❌ 网站访问测试失败: ' + data.message, 'error');
                }
            } catch (error) {
                log('❌ 网站访问测试异常: ' + error.message, 'error');
            }
        }

        // 测试搜索
        async function testSearch() {
            const symbol = document.getElementById('testSymbol').value.trim().toUpperCase();
            if (!symbol) {
                log('❌ 请输入股票代码', 'error');
                return;
            }
            log(`开始测试搜索: ${symbol}...`);
            try {
                const response = await fetch(`/api/stockpltr/debug/search/${symbol}`);
                const data = await response.json();
                if (data.status === 'success') {
                    log(`✅ 搜索测试通过: ${symbol}`, 'success');
                    document.getElementById('crawlerTestResult').innerHTML = 
                        '<div class="alert alert-success">搜索功能正常</div>';
                } else {
                    log(`❌ 搜索测试失败: ${data.message}`, 'error');
                    document.getElementById('crawlerTestResult').innerHTML = 
                        '<div class="alert alert-danger">搜索功能异常</div>';
                }
            } catch (error) {
                log(`❌ 搜索测试异常: ${error.message}`, 'error');
                document.getElementById('crawlerTestResult').innerHTML = 
                    '<div class="alert alert-danger">测试异常</div>';
            }
        }

        // 测试详情获取
        async function testDetail() {
            const symbol = document.getElementById('testSymbol').value.trim().toUpperCase();
            if (!symbol) {
                log('❌ 请输入股票代码', 'error');
                return;
            }
            log(`开始测试详情获取: ${symbol}...`);
            try {
                const response = await fetch(`/api/stockpltr/debug/detail/${symbol}`);
                const data = await response.json();
                if (data.status === 'success') {
                    log(`✅ 详情获取测试通过: ${symbol}`, 'success');
                } else {
                    log(`❌ 详情获取测试失败: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ 详情获取测试异常: ${error.message}`, 'error');
            }
        }

        // 测试评论获取
        async function testComments() {
            const symbol = document.getElementById('testSymbol').value.trim().toUpperCase();
            if (!symbol) {
                log('❌ 请输入股票代码', 'error');
                return;
            }
            log(`开始测试评论获取: ${symbol}...`);
            try {
                const response = await fetch(`/api/stockpltr/debug/comments/${symbol}`);
                const data = await response.json();
                if (data.status === 'success') {
                    log(`✅ 评论获取测试通过: ${symbol} (${data.commentCount}条评论)`, 'success');
                } else {
                    log(`❌ 评论获取测试失败: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ 评论获取测试异常: ${error.message}`, 'error');
            }
        }

        // 加载API状态
        async function loadApiStatus() {
            try {
                const response = await fetch('/api/stockpltr/status');
                const data = await response.json();
                document.getElementById('apiStatus').innerHTML = `
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>服务状态</h6>
                                <span class="badge bg-success">${data.status}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>版本</h6>
                                <span class="badge bg-info">${data.version}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>API端点</h6>
                                <span class="badge bg-primary">${data.endpoints.length}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6>服务名称</h6>
                                <span class="badge bg-secondary">${data.service}</span>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('apiStatus').innerHTML = 
                    '<div class="alert alert-danger">无法获取API状态</div>';
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadApiStatus();
            log('调试工具已就绪');
        });
    </script>
</body>
</html>
